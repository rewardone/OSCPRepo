<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>PAC Validation Detail</title>
</head><body>PAC Validation Detail<br/>
<a href="http://blogs.msdn.com/b/spatdsg/archive/2009/03/26/more-kerberos-fun-with-pac-s.aspx">Decrypting the PAC</a><br/>
<br/>
As described in <a href="http://msdn.microsoft.com/en-us/library/aa302203.aspx">Utilizing the Windows 2000 Authorization Data in Kerberos Tickets for Access Control to Resources</a>:<br/>
<br/>
The PAC is generated by the KDC under the following conditions:<br/>
<ul><li>During an AS request that has been validated with pre-authentication.</li>
<li>During a TGS request when the client has no PAC and the target is a service in the domain or a ticket granting service (referral ticket).</li>
</ul>
<br/>
The PAC contains two digital signatures: one using the key of the server, and one using the key of the KDC. The signatures are present for two reasons. First, the signature with the server’s key is present to prevent a client from generating their own PAC and sending it to the KDC as encrypted authorization data to be included in tickets. Second, the signature with the KDC’s key is present to prevent an untrusted service from forging a ticket to itself with an invalid PAC. The two signatures are sent in PAC_INFO_BUFFERs of type PAC_SERVER_CHECKSUM and PAC_PRIVSVR_CHECKSUM respectively.<br/>
<br/>
The fields are defined as follows:<br/>
<ul><li>SignatureType — This field contains the type of checksum used to create a signature. The checksum must be a keyed checksum.</li>
<li>Signature — This field consists of an array of bytes containing the checksum data. The length of bytes may be determined by the wrapping PAC_INFO_BUFFER structure.</li>
</ul>
<br/>
For the server’s checksum, the key used to generate the signature should be the same key used to encrypt the ticket. Thus, if the enc_tkt_in_skey option is used, the session key from the server’s TGT should be used. The Key used to encrypt ticket-granting tickets is used to generate the KDC’s checksum.<br/>
<br/>
The checksums are computed as follows:<br/>
<ul><li>The complete PAC is built, including space for both checksums</li>
<li>The data portion of both checksums is zeroed.</li>
<li>The entire PAC structure is checksummed with the server’s key, and the result is stored in the server’s checksum structure.</li>
<li>The server’s checksum is then checksummed with the KDC’s key.</li>
<li>The checksum with the KDC key is stored in the KDC’s checksum structure.</li>
</ul>
<br/>
Security Considerations<br/>
Before the PAC data is used for access control, the PAC_SERVER_CHECKSUM signature MUST be checked. This will verify that the provider of the PAC data knows the server’s secret key.<br/>
<br/>
Validation of the PAC_PRIVSVR_CHECKSUM is OPTIONAL. It is used to verify that the PAC was issued from the KDC and not placed in the ticket by someone other than the KDC with access to the service key.<br/>
<br/>
Caution must be used with accepting the SIDs present in the logon-info part of the PAC. Only SIDs from a domain that is authoritative for a particular domain’s SIDs should be used in the construction of access tokens. If a SID is found to be from outside of a domain’s authoritative SID namespace, it MUST be ignored for purposes of access control.<br/>
<br/>
From the MSDN Protocol Reference 4.2: Kerberos PAC Validation:<br/>
<ul>The client tries to access a resource requiring Kerberos authentication. The client sends an AP-REQ message to request authentication from the server.</ul>
<ul>The server passes the PAC to the operating system to receive an access token. The server operating system forwards the PAC signature in the AP-REQ to the domain controller for verification in a KERB_VERIFY_PAC message.</ul>
<ul>The domain controller verifies the signature on the response and returns the result to the server. The error is returned as the appropriate RPC status code.</ul>
<ul><li>The server verifies the AP-REQ, and sends an AP-REP if the verification is successful.</li>
</ul>
</body></html>