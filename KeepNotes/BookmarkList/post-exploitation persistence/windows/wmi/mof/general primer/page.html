<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General Primer</title>
</head><body>MOF files are compiled into the WMI repository using mofcomp.exe. <br/>
A MOF file that is put in the %SystemRoot%\System32\wbem\mof\ directory is automatically compiled and registered into the WMI repository on WinXP. <br/>
It is defined in the registry key HKLM\SOFTWARE\Microsoft\WBEM\CIMOM\<br/>
<br/>
Note: <b>MOF files aren't autocompiled on Vista +</b><br/>
But we can have mofcomp.exe install them locally or remotely.<br/>
<br/>
The file mofcomp.log located in %SystemRoot%\System32\wbem\mof\Logs\ contains the logs about MOF files compilations<br/>
<br/>
This auto-compilation feature was used by Stuxnet: 2 files were uploaded on the targeted remote machine using MS10-061<br/>
<br/>
It is important to remember that the MOF self-install directory is of course only writeable by an Administrator. That's why, MOF files are really interesting in two kinds of situations:<br/>
<ul><li>When we are able to upload a file to a remote machine, into an arbitrary destination path (with Administrator privileges in order to be able to write into the MOF self-install directory). This is the example of MS10-061 with StartDocPrinter API.</li>
<li>In a post-exploitation context, when we have already escalated our privileges to Administrator on a Windows machine. </li>
</ul>
<br/>
The first situation is of course relatively rare. <br/>
Nevertheless, it's interesting to notice that Metasploit provides a function generate_mof() in the file lib/msf/core/exploit/wbemexec.rb. This function uses the trick described in this article to autostart the consumer. For example, it is used by the exploit of MS10-061: exploits/windows/smb/ms10_061_spoolss [13].<br/>
The psexec module (modules/exploits/windows/smb/psexec) also uses it when MOF_UPLOAD_METHOD is selected<br/>
<br/>
<br/>
The Bees Knees<br/>
If set up with care, it is very difficult to detect and even worse to remove. MOF's, in essence, are compiled scripts that describe Common Information Model (CIM) classes which are compiled into the WMI repository. As a method for persistence we will be creating a MOF which <br/>
(1) listens for en event (or events) and <br/>
(2) will take some action (or actions) when the event is triggered.<br/>
<br/>
Premise:<br/>
A MOF file must consist of (at least) the following three components: <br/>
an __EventFilter which uses the WMI Query Language (WQL) to detect a specific event, <br/>
an Event Consumer Class which defines a certain action and <br/>
a __FilterToConsumerBinding which binds an event and an action together. <br/>
</body></html>