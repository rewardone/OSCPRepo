<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>MSDTC</title>
</head><body>The MSDTC service is present on all Windows systems and is turned off 99% of the time. This is good from an attacker's perspective because we don't want to inadvertently break something which might draw attention to our presence. MSDTC is mostly required for database servers when they need to initiate transactions between multiple autonomous agents in a distributed system.<br/>
<br/>
As we can see from the screenshot below, simply starting MSDTC yields 303 "NAME NOT FOUND" entries (nonsensical, I know, but true).<br/>
<br/>
<img src="image.png" /><br/>
<br/>
What we are specifically interested in here is "oci.dll". This dll is an example of a resource which is optional, it would only exist if the Windows machine was used to host an Oracle database. The MSDTC service checks if the dll exists, if it does it will load the dll otherwise it will simply continue with it's start-up routine.<br/>
<br/>
Again, the persistence vector is pretty straight forward. We will want to <br/>
(1) create a dll that contains our malicious shellcode, <br/>
(2) rename it to "oci.dll", <br/>
(3) drop it in one of dll search paths obtained from Procmon and <br/>
(4) configure the MSDTC service to start at boot.<br/>
<br/>
As in our first case study, we could generate a dll with metasploit but for stealth purposes it is much better to inject shellcode into a legitimate dll. Though the process of injecting code in a dll is marginally different a similar technique to the previous case study can be used. For brevity I will not cover the injection process here. This is a challenge I leave for the diligent reader to investigate.<br/>
<br/>
Since I did not have a legitimate version of "oci.dll" I chose a Microsoft dll as a base to inject my shellcode. Below we can see that the details tab of the properties window still shows the original file details.<br/>
<br/>
After the dll has been dropped on the target machine (in C:\Windows\System32\) persistence cab be achieved by using sc to configure MSDTC to start on boot<br/>
<br/>
C:\Windows\system32&gt; sc config msdtc start= auto<br/>
[SC] ChangeServiceConfig SUCCESS<br/>
</body></html>