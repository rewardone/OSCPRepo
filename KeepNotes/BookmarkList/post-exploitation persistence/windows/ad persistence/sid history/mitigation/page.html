<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Mitigation</title>
</head><body>Detection<br/>
The best way to detect SID History account escalation is to enumerate all users with data in the SID History attribute and flag the ones which include SIDs in the same domain*. If users haven’t been migrated, you can simply search for all users with data in the SIDHistory attribute. This is why it’s important to clean up SID History after a migration is complete (and the user is added to the correct groups for required resource access).<br/>
<br/>
The PowerShell AD Cmdlet “Get-ADUser” is most useful for detecting “Same Domain SID History”:<br/>
<br/>
&nbsp; &nbsp; # Detect Same Domain SID History<br/>
&nbsp; &nbsp; Import-Module ActiveDirectory<br/>
&nbsp; &nbsp; [string]$DomainSID = ( (Get-ADDomain).DomainSID.Value )<br/>
<br/>
&nbsp; &nbsp; Get-ADUser -Filter “SIDHistory -Like ‘*'” -Properties SIDHistory | `<br/>
&nbsp; &nbsp; Where { $_.SIDHistory -Like “$DomainSID-*” }<br/>
<br/>
This graphic shows the result of running the “Same Domain SIDHistory” Detection PowerShell Script. Note that the SID in the user’s SIDHistory ends with “500” which is the default domain Administrator account which is a member of Administrators, Domain Admins, Schema Admins, and Enterprise Admins by default.<br/>
<br/>
*Note: In multi-domain forests, it is recommended to look for admin group SIDs (and member account SIDs) in every domain in the forest as well as trusted domains/forests.<br/>
<br/>
Detection via Domain Controller Events<br/>
Detection of successful modification or failed attempt to modify the SIDHistory attribute is possible with the following logging:<br/>
<br/>
Configure sub-category auditing under Account Management, &nbsp;“Audit User Account Management” (success) on Domain Controllers for the following event ids:<br/>
<br/>
&nbsp; &nbsp; 4765: SID History was added to an account.<br/>
&nbsp; &nbsp; 4766: An attempt to add SID History to an account failed.<br/>
</body></html>