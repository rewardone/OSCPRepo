<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General Primer</title>
</head><body>The Skeleton Key malware is installed on one or multiple Domain Controllers running a supported 64bit OS.<br/>
The malware “patches” the security system enabling a new master password to be accepted for any domain user, including admins.<br/>
<br/>
This enables the attacker to logon as any user they want with the master password (skeleton key) configured in the malware.<br/>
“Joe User” logs in using his usual password with no changes to his account. &nbsp;The attacker can log in as Joe using the skeleton key password and it is seen as a valid logon…<br/>
Key Points:<br/>
<br/>
&nbsp; &nbsp; Requires domain-level admin rights (and debug rights which admins have by default) to “patch” LSASS on a Domain Controller.<br/>
&nbsp; &nbsp; All existing user account passwords continue working as normal.<br/>
&nbsp; &nbsp; Adds a new password that enables the attacker to log on as any user with this password – this is the “skeleton key”.<br/>
&nbsp; &nbsp; Active Directory Domain Controllers may experience replication issues.<br/>
&nbsp; &nbsp; User accounts that require a smart card for authentication are not affected.<br/>
&nbsp; &nbsp; The Skeleton Key malware currently <b>doesn’t remain active after a reboot</b>&nbsp;– rebooting the DCs removes the in-memory patch. Note that DCs are typically only rebooted about once a month.<br/>
&nbsp; &nbsp; The Skeleton Key malware only works on the following 64-bit systems: Windows Server 2008, Windows Server 2008 R2, and Windows Server 2003 R2.<br/>
&nbsp; &nbsp; Performs Kerberos encryption downgrade to RC4_HMAC_MD5<br/>
&nbsp; &nbsp; Mimikatz now has skeleton key functionality and seems to work on all versions of Windows Server…<br/>
&nbsp; &nbsp; Protect your Active Directory admin accounts and don’t let untrusted code run on Domain Controllers.<br/>
<br/>
<br/>
Skeleton Key Malware Actions:<br/>
<br/>
&nbsp; &nbsp; When run, Skeleton Key performs the following tasks:<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Check for one of the following compatible 64-bit Windows versions. The malware is not compatible with 32-bit Windows versions or with Windows Server versions beginning with Windows Server 2012 (6.2).<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6.1 (Windows 2008 R2)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6.0 (Windows Server 2008)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5.2 (Windows 2003 R2)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Use the SeDebugPrivilege function to acquire the necessary administrator privileges to write to the Local Security Authority Subsystem Service (LSASS) process. This process controls security functions for the AD domain, including user account authentication.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Enumerate available processes to acquire a handle to the LSASS process.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Obtain addresses for the authentication-related functions that will be patched:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CDLocateCSystem — located in cryptdll.dll<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SamIRetrieveMultiplePrimaryCredentials — located in samsrv.dll<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SamIRetrievePrimaryCredentials — located in samsrv.dll<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Perform OS-specific adjustments using the global variable set during the compatibility check in Step 1.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Use the OpenProcess function to acquire a handle to the LSASS process.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Reserve and allocate the required memory space to edit and patch the LSASS process’s memory.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Patch relevant functions based on the operating system:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CDLocateCSystem (all compatible Windows versions)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SamIRetrieveMultiplePrimaryCredentials (only Windows 2008 R2 (6.1))<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SamIRetrievePrimaryCredentials (all compatible Windows versions other than Windows 2008 R2 (6.1))<br/>
<br/>
<br/>
Skeleton Key performs the following steps to patch each function:<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Call the VirtualProtectEx function to change the memory protection to allow writing to the required memory allocations (PAGE_EXECUTE_READWRITE, 0x40). This step allows the function’s code to be updated in memory.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Call the WriteProcessMemory function to change the address of the target function to point to the patched code. This change causes calls to the target function to use the patch instead.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Restore the original memory protection by calling VirtualProtectEx with the original memory protection flags. This step is likely to avoid suspicious writable and executable memory allocations.<br/>
<br/>
While this issue was recently published, based on file data, it is likely it has been around for a while.<br/>
<br/>
Mimikatz Skeleton Key Functionality:<br/>
<br/>
Benjamin Delpy updated Mimikatz (version 2.0 alpha, Jan 17 2015 01:24:17) with skeleton key functionality.<br/>
Mimikatz can now inject a skeleton key into LSASS on the Domain Controller by running the following command on the DC:<br/>
&nbsp; &nbsp; mimikatz.exe “privilege::debug” “misc::skeleton” exit</body></html>