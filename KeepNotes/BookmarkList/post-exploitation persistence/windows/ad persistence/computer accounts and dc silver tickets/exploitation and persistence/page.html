<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Exploitation and Persistence</title>
</head><body><b>Domain Controller Silver Ticket</b><br/>
<br/>
If the attacker has dumped the Active Directory database or gained knowledge of a Domain Controller's computer account passwor,d the attacker can use Silver Tickets to target the Domain Controller's service as an admin and <a href="https://adsecurity.org/?p=2011">persist in Active Directory with full admin rights.</a>&nbsp; <br/>
<br/>
Once the attacker gains knowledge of a Domain Controller's computer account, this information can be used to create a Silver Ticket providing long-term admin rights to that DC. <br/>
<br/>
Computers host services as well with the most common one being the Windows file share which leverages the "cifs" service. Since the computer itself hosts this service, the password data required to create a Silver Ticket is the associated computer account's password hash. When a computer is joined to Active Directory, a new computer account object is created and linked to the computer. The password and associated hash is stored on the computer that owns the account and the NTLM password hash is stored in the Active Directory database on the Domain Controllers for the domain.<br/>
<br/>
If an attack can gain admin rights to the computer (to gain debug access) or be able to run code as local &nbsp;System, the attacker can dump the AD comptuer account password hash from the system using Mimikatz (the NTLM password hash is used to encrypt RC4 Kerberos tickets): Mimikatz "privilege::debug" "sekurlsa::logonpasswords" exit<br/>
<br/>
<b>Create a Silver Ticket for the DC to Connect to PowerShell Remoting on the Domain Controller with Admin Access</b>&nbsp;<br/>
<br/>
Create a Silver Ticket for the "<a href="https://adsecurity.org/?page_id=183">http</a>" service and "<a href="https://adsecurity.org/?page_id=183">wsman</a>" service to gain admin rights to WinRM and/or PowerShell Remoting on the target system.<br/>
kerberos::golden /admin:&lt;username&gt; /domain:&lt;domain&gt; /id:&lt;id&gt; /sid:&lt;sid&gt; /target:&lt;target&gt; /rc4:&lt;rc4&gt; /service:HTTP /ptt<br/>
<br/>
After injecting the two Silver Tickets, http and wsman, we cna use PowerShell Remoting or WinRM to oppen a shell to the target system (assuming it's confugred with PowerShell Remoting and/or WinRM). New-PSSession is the PowerShell cmdlet for creating a session to a remote system using PowerShell and Enter-PSSession opens the remote shell. <br/>
<br/>
New-PSSession -Name PSC -ComputerName ADSDC02 ; Enter-PSSession -Name PSC<br/>
<br/>
<a href="https://adsecurity.org/?page_id=183">Cretae a Silver Ticket for the DC to Connect to LDAP on the Domain Controller with Admin Access and Run DCSYNC</a>&nbsp;<br/>
Create a Silver Ticket for the "ldap" service to gain admin rights to LDAP services on the target system (including Active Directory)<br/>
Leveraging the LDAP Silver Ticket, we can use Mimikatz and run <a href="https://adsecurity.org/?p=1729">DCSync</a>&nbsp;to "replicate" credentials from the DC<br/>
<br/>
<b>Persistence via Computer Account</b>&nbsp;<br/>
Assuming that an attacker is able to compromise the domain, a sneaky way to maintain elevated domain rights is to add a computer account (or group containing computers) to have <a href="https://adsecurity.org/?p=2011">rights to areas of Active &nbsp;Directory useful for persisting</a>. <br/>
This method is two-pronged:<br/>
<br/>
1) Compromise the computer account password on an adminor backup server in the environment which enables access to that system (<a href="https://adsecurity.org/?p=2011">disable computer account password updates to ensure continued access</a>)<br/>
2) <a href="https://adsecurity.org/?p=1929">Delegate rights</a>&nbsp;to that server's computer account (or a group containing it) to critical AD components<br/>
<br/>
Another way to leverage a computer account for AD persistence is to place the computer account in a privileged group that has other accounts. Here's a common example: There's a group called "AD Backups" which has a service account as a member called "svc-backup."<br/>
<br/>
When enumerating the group membership of the domain Adminsitrators group (which has full AD admin rights as well as full admin rights to Domain Controllers in the domain), we see that the "AD Backups" group is included. This is an all too common configuration, though being a member of Domain Admins would be worse. Ideally, the backups group or service accountshould only be a member of "Backup Operators" in the domain in order to backup AD domain data. <br/>
<br/>
The attacker &nbsp;adds the compromised computer account to the "AD Backups" grou pand does nothing else. The ADSAP01 computer account now provides the attacker with full admin rights to the domain and all Domain Controllers and is able to run Mimikatz DCSync at will to pull password data for any account. <br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
</body></html>