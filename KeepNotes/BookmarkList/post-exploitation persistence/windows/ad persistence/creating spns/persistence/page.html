<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Persistence</title>
</head><body>The Attack (Privilege Escalation / Persistence) <br/>
If an attacker gains the necessary access (DA or ability to add SPNs to admin accounts), they can configure a fake service principal name on an admin account.<br/>
&nbsp;<br/>
Here’s how this works:<br/>
&nbsp;<ul><li>The attacker has admin rights over the domain or SPN modify rights, on certain accounts or all domain accounts.</li>
<li>They add fake SPNs to the admin accounts they want to retain access to. In this example, we add a SPN that’s associated with an admin server (each account should have a unique SPN, ex. “adm/adminsrv01.lab.adsecurity.org”).</li>
<li>The owner of the account changes their password and the attacker loses the level of access they had.</li>
<li>The attacker now simply needs to request RC4 Kerberos tickets for the fake SPNs created earlier.</li>
<li>The attacker can then take the requested tickets, save them out of memory to files, move them to another system,  and crack them offline with a tool like Kerberoast, hashcat, etc.</li>
</ul>
<br/>
<br/>
There’s a couple different angles to this attack/persistence method:<br/>
&nbsp;<ul><li>Add SPNs to admin accounts for which the attacker wants to retain access.</li>
<li>Add fake SPNs to admin accounts for which the attacker wants to get the passwords.</li>
</ul>
<br/>
<b>NOTE:</b>&nbsp;An attacker could also grant rights to certain OUs containing admin accounts to provide a regular user account to modify the ServicePrincipalName attribute on the admin accounts in these OU. All that’s required is delegating the “Write ServicePrincipalName” access right (Full Control does not provide SPN modification rights). Though this isn’t straightforward to configure via AD Users &amp; Computers since the access right is hidden in the GUI by default.<br/>
</body></html>