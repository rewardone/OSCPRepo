<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>SMB Magic</title>
</head><body>&nbsp;So, as it turns out the newer versions of Samba have the ability to replicate from a domain controller and then you can convert that into a huge keytab.<br/>
<br/>
To use this 'feature' you need a newer version of Samba. &nbsp;This means compiling from scratch. &nbsp;Beyond the scope of what I'm writing about here, but it wasn't hard. &nbsp;Couple annoying dependencies and some multi-core compiling later I have a new build in /opt/smb.<br/>
<br/>
This magical command is called 'samba-tool'. &nbsp;You can use it to replicate a remote DC (with an admin user of course) and it will dump the contents to a directory of your choosing. &nbsp;Plus you can use Kerberos, so you can simply use an existing ticket you received from OPTH. <br/>
<br/>
amba-tool drs clone-dc-database --include-secrets --targetdir=&lt;dir&gt; &lt;DOMAIN in CAPS&gt; -k1 <br/>
<br/>
You need to specify 'targetdir' and the domain obviously. &nbsp;The '-k1' tells it to use kerberos. &nbsp;My test domain has a large number of objects (computers / users/ groups ) that I created using Joeware's admod to give it some size.<br/>
<br/>
&nbsp;So, this scrolls on for a bit until it's pumped the DC dry. &nbsp;The next step takes the data from here and generates a keytab file with everything in it. &nbsp;Note this step takes a long time. &nbsp;On my machine it took a few hours. &nbsp;There might be a way to optimize things a tad if you don't want everything.<br/>
<br/>
Anywhoo... without further ado:<br/>
<br/>
samba-tool domain exportkeytab &lt;filename&gt; -s &lt;path to configfile&gt;<br/>
<br/>
&nbsp;Note that the new keytab can be whatever you want it to be, however the config file was actually generated by the previous command. &nbsp;Like I said earlier, this command takes a while for my largish domain, but I ended up with a keytab file with all keys (AES, NTLM, DES) from the domain. &nbsp;And in a much more compact format. &nbsp;My combined file for the domain is ~6meg.<br/>
<br/>
You can list the keys contained in a keytab file using ktutil and can even get the actual keys themselves if you tack on '--keys'. </body></html>