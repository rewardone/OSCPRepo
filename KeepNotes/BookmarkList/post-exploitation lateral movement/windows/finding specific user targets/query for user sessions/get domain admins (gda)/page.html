<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Get Domain Admins (GDA)</title>
</head><body><a href="https://github.com/nullbind/Other-Projects/tree/master/GDA">https://github.com/nullbind/Other-Projects/tree/master/GDA</a>&nbsp;<br/>
----------------------------<br/>
Script Name: Get Domain Admins (GDA)<br/>
Author: Scott Sutherland (nullbind) &lt;scott.sutherland@netspi.com&gt;<br/>
Date: 12/5/2011<br/>
<br/>
----------------------------<br/>
Shout Outz!<br/>
----------------------------<br/>
Thank you Mark Beard (pacmandu) &lt;pacmandu@gmail.com&gt; and humble-desser for<br/>
taking the time to mod this script so that it can use <br/>
multipart domain names. &nbsp;Also, thank you for testing it out on the <br/>
following compatable flavors of Windows: <br/>
- Windows XP<br/>
- Windows 7<br/>
- Win2003 server <br/>
- Win2008 server<br/>
<br/>
Finally, I would also like to thank Joe Richards of joeware.net. &nbsp;He has <br/>
created a fantastic ADS toolset. &nbsp;Without him this script <br/>
wouldn't exist.<br/>
<br/>
----------------------------<br/>
Script Summary<br/>
----------------------------<br/>
The primary goal of this script is to locate systems <br/>
running processes with a Domain Admin account so that penetesters<br/>
can conduct cleaner privilege escalation in Active Directory domains. &nbsp;<br/>
This way pentesters dont have to spray shells all over the place with<br/>
metasploit+psexec+meterpreter and scrape for admin tokens. :)<br/>
<br/>
Fewer sprayed shells = Less risk of service disruptions = Happy client/boss<br/>
&#09;&#09;&#09;&#09; &nbsp; and<br/>
&#09;&#09;&#09;Higher likelyhood of <br/>
&#09;&#09;&#09;escalating to Domain Admin<br/>
&#09;&#09;&#09;quickly<br/>
<br/>
----------------------------<br/>
How it Works<br/>
----------------------------<br/>
1. Gather a list of Domain Controllers from the ADS "Domain Controllers" OU <br/>
&nbsp; &nbsp;using LDAP and a trusted connection. - (adfind.exe)<br/>
&nbsp; &nbsp;<br/>
2. Gather a list of Domain Admins from the ADS "Domain Admins" group using <br/>
&nbsp; &nbsp;LDAP and a trusted connection. - (adfind.exe)<br/>
&nbsp; &nbsp;<br/>
3. Gather a list of all of the active sessions being tracked on <br/>
&nbsp; &nbsp;each of the domain controllers using netsessionenum API. - (netsess.exe)<br/>
&nbsp; &nbsp;<br/>
&nbsp; &nbsp;The following information will be returned:<br/>
&nbsp; &nbsp;- IP address<br/>
&nbsp; &nbsp;- Username <br/>
&nbsp; &nbsp;- Session start time<br/>
&nbsp; &nbsp;- Session idle time<br/>
&nbsp; &nbsp;<br/>
4. Cross reference the Domain Admin list with the active session list to determine which IP addresses<br/>
&nbsp; &nbsp;have processes being run as a Domain Admin.<br/>
&nbsp; &nbsp;<br/>
5. Take the natural next steps. (metasploit+psexec+meterpreter)<br/>
<br/>
Note: In environments where there are very few domain admins, and they are using seperate accounts<br/>
&nbsp; &nbsp; &nbsp; you may have to run it a few times until you catch them in an active sesions, but in larger<br/>
&nbsp; &nbsp; &nbsp; environments you can almost always catch a service account doing in daily tasks.<br/>
&nbsp; &nbsp; &nbsp; My hope is that Mubix and Jabra will create some fun Metasploit modules that take advantage of <br/>
&nbsp; &nbsp; &nbsp; this approach using Railgun and Jabra's current escalation module, but I still need to followup<br/>
&nbsp; &nbsp; &nbsp; with them....to be continued...<br/>
<br/>
&nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<br/>
----------------------------<br/>
Instructions - Installation <br/>
----------------------------<br/>
<br/>
1. Download the freeware tools below to the same directory as the GDA.bat.<br/>
<br/>
Source - http://www.joeware.net/freetools/<br/>
- NetSess.exe <br/>
- adfind.exe <br/>
- findpdc.exe<br/>
<br/>
Source - http://sourceforge.net/projects/unxutils/<br/>
- grep.exe <br/>
- gawk.exe &nbsp;<br/>
- uniq.exe<br/>
<br/>
2. Run desired command.<br/>
<br/>
------------------------------------------------------------------<br/>
Instructions - Identify Systems with active Domain Admin sessions - Target Default Domain<br/>
------------------------------------------------------------------<br/>
1. Open a Windows command console and navigate to the GDA directory. <br/>
<br/>
2. Type gda -a to locate domain admin sessions for the current user's domain. <br/>
<br/>
3. Collect the list of domain controllers, domain admins, and systems with domain admin sessions from datargets.txt.<br/>
<br/>
------------------------------------------------------------------<br/>
Instructions - Identify Systems with active Domain Admin sessions - Target NON Default Domain<br/>
------------------------------------------------------------------<br/>
1. Open a Windows command console and navigate to the GDA directory. <br/>
<br/>
2. Type gda -c subdomain.domain.com to locate domain admin sessions for a domain other than the one the current<br/>
&nbsp; &nbsp;usre belongs to.<br/>
<br/>
3. Collect the list of domain controllers, domain admins, and systems with domain admin sessions from datargets.txt.<br/>
<br/>
Note: Right now this usually only works when looking up info from domains with trust relationships to the default domain.<br/>
<br/>
------------------------------------------------------------------<br/>
Instructions - Enumerate domain users for the current domain<br/>
------------------------------------------------------------------<br/>
1. Open a Windows command console and navigate to the GDA directory. <br/>
<br/>
2. Type gda -l to enumerate users for the current domain using ldap and a trusted connection for the current user.<br/>
<br/>
3. Collect the list domain users from user_ldap.txt.</body></html>