<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>GDA.bat</title>
</head><body>@echo off<br/>
cls<br/>
<br/>
REM #######################################################<br/>
REM Author and Stuff<br/>
REM #######################################################<br/>
REM Script Name: Get Domain Admins (GDA)<br/>
REM Author: Scott Sutherland (nullbind) &lt;scott.sutherland@netspi.com&gt;<br/>
REM Publish Date: 12/5/2011<br/>
<br/>
REM #######################################################<br/>
REM Shout Outz!<br/>
REM #######################################################<br/>
REM Thank you Mark Beard (pacmandu) &lt;pacmandu@gmail.com&gt; and humble-desser<br/>
REM for your updating the script to accept multipe part domain names.<br/>
<br/>
REM #######################################################<br/>
REM Script Summary<br/>
REM #######################################################<br/>
REM The primary goal of this script is to locate systems <br/>
REM running processes with a Domain Admin account so that penetesters<br/>
REM can conduct cleaner privilege escalation in Active Directory domains. &nbsp;<br/>
REM This way pentesters dont have to spray shells all over the place with<br/>
REM metasploit+psexec+meterpreter and scrape for admin tokens. :)<br/>
<br/>
REM #######################################################<br/>
REM Check &nbsp;Variables <br/>
REM #######################################################<br/>
REM - Target Domain<br/>
IF EXIST target del target<br/>
echo %userdnsdomain% | gawk -F "." "{print $0}" &gt; target<br/>
SET /p target_domain= &lt; target<br/>
DEL target<br/>
<br/>
<br/>
REM - Checking total number of words in a given domain name and save on totalvar <br/>
IF EXIST num_words del num_words<br/>
echo %userdnsdomain% | gawk &nbsp;-F "." "{ total = total + NF }; END { print total+0 }" &gt; num_words<br/>
SET /p totalvar= &lt; num_words<br/>
DEL num_words<br/>
<br/>
REM - Define all variables to be used later (e.g: var1=hacking, var2=lab, var3=local)<br/>
IF EXIST domainname del domainname<br/>
FOR /L %%G IN (1,1,%totalvar%) DO (echo %userdnsdomain% | gawk -F "." "{print $%%G}" &gt; %%G<br/>
SET /p var%%G= &lt; %%G<br/>
gawk "BEGIN { while (a++&lt;1) s=s \"dc=%%var%%G%%\"; print s }" &gt;&gt; domainname<br/>
DEL %%G )<br/>
<br/>
REM - Parsing the domain variables to be insert into domain_parameters (e.g: dc=%var1%,dc=%var2%,dc=%var3%)<br/>
IF EXIST domainname_var del domainname_var<br/>
gawk "NR==1{x=$0;next}NF{x=x\",\"$0}END{print x}" domainname &gt; domainname_var<br/>
DEL domainname<br/>
<br/>
REM - Fix parsing issues<br/>
IF EXIST domainname_var2 del domainname_var2<br/>
SET /p temp_var= &lt; domainname_var<br/>
@echo %temp_var% | sed "s/'//" &gt; domainname_var2<br/>
SET /p domain_parameter= &lt; domainname_var2<br/>
DEL domainname_var <br/>
DEL domainname_var2<br/>
&nbsp;<br/>
REM #######################################################<br/>
REM - Preparing arguments passed by "-c" (custom) flag <br/>
REM #######################################################<br/>
<br/>
IF EXIST c_target del c_target<br/>
@echo %2 &gt; c_target<br/>
SET /p c_target_domain= &lt; c_target<br/>
DEL c_target<br/>
<br/>
IF EXIST c_num_words del c_num_words<br/>
@echo %2 | gawk &nbsp;-F "." "{ total = total + NF }; END { print total+0 }" &gt; c_num_words<br/>
SET /p c_totalvar= &lt; c_num_words<br/>
DEL c_num_words<br/>
<br/>
<br/>
IF EXIST c_domainname del c_domainname<br/>
FOR /L %%G IN (1,1,%c_totalvar%) DO (echo %2 | gawk -F "." "{print $%%G}" &gt; %%G<br/>
SET /p c_var%%G= &lt; %%G<br/>
gawk "BEGIN { while (a++&lt;1) s=s \"dc=%%c_var%%G%%\"; print s }" &gt;&gt; c_domainname<br/>
DEL %%G )<br/>
<br/>
REM - Parsing the domain variables to be insert into domain_parameters (e.g: dc=%var1%,dc=%var2%,dc=%var3%)<br/>
IF EXIST c_domainname_var del c_domainname_var<br/>
gawk "NR==1{x=$0;next}NF{x=x\",\"$0}END{print x}" c_domainname &gt; c_domainname_var<br/>
DEL c_domainname<br/>
<br/>
REM - Fix parsing issues<br/>
IF EXIST c_domainname_var2 del c_domainname_var2<br/>
SET /p c_temp_var= &lt; c_domainname_var<br/>
@echo %c_temp_var% | sed "s/'//" &gt; c_domainname_var2<br/>
SET /p c_domain_parameter= &lt; c_domainname_var2<br/>
DEL c_domainname_var <br/>
DEL c_domainname_var2<br/>
<br/>
<br/>
if [%1] equ [] goto :SYNTAX<br/>
if [%1] equ [-h] goto :SYNTAX<br/>
if [%1] equ [-c] goto :CUSTOM<br/>
if [%1] equ [-a] goto :CURRENT<br/>
if [%1] equ [-l] goto :DUMPUSERSLDAP<br/>
if [%1] equ [-s] goto :DUMPUSERSSMB<br/>
<br/>
<br/>
goto :end<br/>
REM #######################################################<br/>
<br/>
:SYNTAX<br/>
echo ------------------------------------------------------------<br/>
echo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GET DOMAIN ADMIN (GDA)<br/>
echo ------------------------------------------------------------<br/>
echo This script can be used to enumerate users that exist in <br/>
echo the current machines domain and locate systems running <br/>
echo processes as a domain admin<br/>
echo ------------------------------------------------------------<br/>
echo Syntax: <br/>
echo -l Dump list of users from current domain using LDAP<br/>
echo -s dumps list of users from current domain using SMB (enum)<br/>
echo -c Get list of DA sessions - custom domain<br/>
echo -a Get list of DA sessions - local machine's domain<br/>
echo ------------------------------------------------------------<br/>
REM #######################################################<br/>
REM Check for require binaries<br/>
REM #######################################################<br/>
IF NOT EXIST NetSess.exe GOTO missingfiles<br/>
IF NOT EXIST grep.exe GOTO missingfiles<br/>
IF NOT EXIST gawk.exe GOTO missingfiles<br/>
IF NOT EXIST adfind.exe GOTO missingfiles<br/>
IF NOT EXIST uniq.exe GOTO missingfiles<br/>
IF NOT EXIST findpdc.exe GOTO missingfiles<br/>
goto end<br/>
<br/>
:missingfiles<br/>
echo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ERROR<br/>
echo ----------------------------------------<br/>
echo The following required files <br/>
echo are missing:&#09;<br/>
echo - NetSess.exe <br/>
echo - grep.exe <br/>
echo - gawk.exe &nbsp;<br/>
echo - adfind.exe <br/>
echo - uniq.exe<br/>
echo - findpdc.exe<br/>
goto :end<br/>
<br/>
:DUMPUSERSLDAP<br/>
IF EXIST users_ldap.txt del users_ldap.txt<br/>
echo HERE:%domain_parameter%<br/>
@adfind -b %domain_parameter% -f "objectcategory=user" -gc | grep -i "sAMAccountName:" | gawk -F ":" "{print $2}" | gawk -F " " "{print $1}"| sort &gt; users_ldap.txt<br/>
echo .<br/>
echo .<br/>
echo Results have been exported to users_ldap.txt<br/>
goto :END<br/>
<br/>
:DUMPUSERSSMB<br/>
findpdc %userdomain% 1 &gt;&gt; pdc1.txt<br/>
gawk -F "\\" "{print $3}" pdc1.txt &gt; pdc.txt<br/>
SET /P PDC= &lt; pdc.txt<br/>
del pdc1.txt<br/>
del pdc.txt<br/>
enum.exe -N &nbsp;%PDC% | grep -v "getting" | grep -v "up..." | grep -v "\$" | grep -v "server:" | gawk -F " " "{print $1}" &gt;&gt; users_smb1.txt<br/>
enum.exe -N &nbsp;%PDC% | grep -v "getting" | grep -v "up..." | grep -v "\$" | grep -v "server:" | gawk -F " " "{print $2}" &gt;&gt; users_smb1.txt<br/>
enum.exe -N &nbsp;%PDC% | grep -v "getting" | grep -v "up..." | grep -v "\$" | grep -v "server:" | gawk -F " " "{print $3}" &gt;&gt; users_smb1.txt<br/>
enum.exe -N &nbsp;%PDC% | grep -v "getting" | grep -v "up..." | grep -v "\$" | grep -v "server:" | gawk -F " " "{print $4}" &gt;&gt; users_smb1.txt<br/>
cat users_smb1.txt | grep -v "^$" | uniq | sort &gt; users_smb.txt<br/>
del users_smb1.txt<br/>
users_smb.txt<br/>
<br/>
goto :end<br/>
<br/>
:CUSTOM<br/>
IF EXIST datargets.txt del datargets.txt<br/>
REM ####################################################### <br/>
REM GET LIST OF DOMAIN CONTROLLERS WITH ADFIND<br/>
REM ####################################################### <br/>
@adfind -b -sc dcdmp %c_domain_parameter% -gc | grep -i "&gt;name:" | gawk -F " " "{print $2}" | sort | uniq &gt;&gt; dcs.txt 2&gt;&amp;1<br/>
echo -----------------------------------------------<br/>
echo Getting list of Domain Controllers...<br/>
echo -----------------------------------------------<br/>
<br/>
REM ####################################################### <br/>
REM GET LIST OF DOMAIN ADMINS WITH ADFIND<br/>
REM ####################################################### <br/>
echo -----------------------------------------------<br/>
echo Getting list of Domain Admins...<br/>
echo -----------------------------------------------<br/>
@adfind -b %c_domain_parameter% -f name="Domain Admins" -gc &gt; myadmins1.txt<br/>
grep -i "member:" myadmins1.txt &gt; myadmins2.txt<br/>
sed -e s/^&gt;member:" "CN=/'/g myadmins2.txt &gt; myadmins3.txt<br/>
sed -e s/,/',/g myadmins3.txt &gt; myadmins4.txt<br/>
type myadmins4.txt | gawk -F "," "{print $1}" &gt; myadmins5.txt<br/>
sed s/'//g myadmins5.txt &gt; dcadmintmp.txt<br/>
REM DEL myadmins*.txt<br/>
<br/>
REM PARSE LIST OF DOMAIN ADMINS<br/>
FOR /f "tokens=1 delims=" %%a IN ('type dcadmintmp.txt') do @adfind -b %c_domain_parameter% -f name="%%a" | grep -i "sAMAccountName" | sed -e s/^&gt;sAMAccountName:" "//g &gt;&gt; dcadmins.txt<br/>
DEL dcadmintmp.txt<br/>
<br/>
REM ####################################################### <br/>
REM SCAN FOR ACTIVE DOMAIN ADMIN SESSIONS (NETSESS)<br/>
REM ####################################################### <br/>
echo -----------------------------------------------<br/>
echo Getting list of Active Domain Admin Sessions...<br/>
echo -----------------------------------------------<br/>
for /f %%a in ('type dcs.txt') do NetSess.exe %%a &gt;&gt; mysessions.txt <br/>
<br/>
REM Identify domain admin sessions<br/>
for /f %%a in ('type dcadmins.txt') do grep -i %%a mysessions.txt &gt;&gt; mysessions2.txt<br/>
<br/>
echo =============================&gt;&gt;datargets.txt<br/>
echo TARGET DOMAIN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
echo -----------------------------&gt;&gt;datargets.txt<br/>
echo %c_target_domain% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
echo _ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
goto :report<br/>
<br/>
<br/>
:CURRENT<br/>
IF EXIST datargets.txt del datargets.txt<br/>
REM ####################################################### <br/>
REM GET LIST OF DOMAIN CONTROLLERS WITH ADFIND<br/>
REM ####################################################### <br/>
findpdc %userdomain% 1 &gt;&gt; pdc1.txt<br/>
gawk -F "\\" "{print $3}" pdc1.txt &gt; pdc.txt<br/>
SET /P PDC= &lt; pdc.txt<br/>
del pdc1.txt<br/>
del pdc.txt<br/>
@adfind -b -sc dcdmp %domain_parameter% -f name=%PDC% -gc | grep -i "&gt;name:" | gawk -F " " "{print $2}" | sort | uniq &gt;&gt; dcs.txt 2&gt;&amp;1<br/>
echo -----------------------------------------------<br/>
echo Getting list of Domain Controllers...<br/>
echo -----------------------------------------------<br/>
<br/>
REM ####################################################### <br/>
REM GET LIST OF DOMAIN ADMINS WITH ADFIND<br/>
REM ####################################################### <br/>
echo -----------------------------------------------<br/>
echo Getting list of Domain Admins...<br/>
echo -----------------------------------------------<br/>
@adfind -b %domain_parameter% -f name="Domain Admins" -gc &gt; myadmins1.txt<br/>
grep -i "member:" myadmins1.txt &gt; myadmins2.txt<br/>
sed -e s/^&gt;member:" "CN=/'/g myadmins2.txt &gt; myadmins3.txt<br/>
sed -e s/,/',/g myadmins3.txt &gt; myadmins4.txt<br/>
type myadmins4.txt | gawk -F "," "{print $1}" &gt; myadmins5.txt<br/>
sed s/'//g myadmins5.txt &gt; dcadmintmp.txt<br/>
REM del myadmins*.txt<br/>
<br/>
REM PARSE LIST OF DOMAIN ADMINS<br/>
FOR /f "tokens=1 delims=" %%a IN ('type dcadmintmp.txt') do @adfind -b %domain_parameter% -f name="%%a" | grep -i "sAMAccountName" | sed -e s/^&gt;sAMAccountName:" "//g &gt;&gt;dcadmins.txt<br/>
DEL dcadmintmp.txt<br/>
<br/>
REM ####################################################### <br/>
REM SCAN FOR ACTIVE DOMAIN ADMIN SESSIONS (NETSESS)<br/>
REM ####################################################### <br/>
echo -----------------------------------------------<br/>
echo Getting list of Active Domain Admin Sessions...<br/>
echo -----------------------------------------------<br/>
FOR /f %%a in ('type dcs.txt') do NetSess.exe %%a &gt;&gt; mysessions.txt <br/>
<br/>
REM Identify domain admin sessions<br/>
FOR /f %%a in ('type dcadmins.txt') do grep -i %%a mysessions.txt &gt;&gt; mysessions2.txt<br/>
<br/>
echo =============================&gt;&gt;datargets.txt<br/>
echo TARGET DOMAIN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
echo -----------------------------&gt;&gt;datargets.txt<br/>
echo %userdnsdomain% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
echo _ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
<br/>
:report<br/>
REM ####################################################### <br/>
REM PRINT REPORT<br/>
REM #######################################################<br/>
echo .<br/>
echo .<br/>
echo =============================&gt;&gt;datargets.txt<br/>
echo Domain Controllers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &gt;&gt;datargets.txt<br/>
echo -----------------------------&gt;&gt;datargets.txt<br/>
echo =============================<br/>
echo Domain Controllers<br/>
echo -----------------------------<br/>
uniq dcs.txt | sort &gt;&gt; datargets.txt<br/>
uniq dcs.txt | sort<br/>
<br/>
<br/>
echo =============================<br/>
echo Domain Admins<br/>
echo -----------------------------<br/>
echo _ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt<br/>
echo =============================&gt;&gt;datargets.txt<br/>
echo Domain Admins&#09; &nbsp; &#09;&#09;&#09; &nbsp;&gt;&gt;datargets.txt<br/>
echo -----------------------------&gt;&gt;datargets.txt<br/>
uniq dcadmins.txt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &gt;&gt;datargets.txt<br/>
uniq dcadmins.txt<br/>
del dcadmins.txt<br/>
<br/>
echo _ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&gt;datargets.txt &nbsp; <br/>
echo =============================&gt;&gt;datargets.txt<br/>
echo Active Domain Admin Sessions &gt;&gt;datargets.txt<br/>
echo =============================&gt;&gt;datargets.txt<br/>
echo =============================<br/>
echo Active Domain Admin Sessions <br/>
echo -----------------------------<br/>
uniq mysessions2.txt | sort &gt;&gt; datargets.txt<br/>
uniq mysessions2.txt<br/>
<br/>
REM ## If the user uploads GDA via meterpreter there is no point to open datargets.txt on notepad<br/>
REM -- start datargets.txt<br/>
<br/>
DEL myadmin*.txt<br/>
<br/>
echo .<br/>
echo .<br/>
echo Results have been exported to datargets.txt<br/>
DEL mysessions2.txt<br/>
DEL mysessions.txt<br/>
DEL dcs.txt<br/>
<br/>
<br/>
:end</body></html>