<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Pentestlab Primer</title>
</head><body><a href="https://pentestlab.blog/2017/03/27/dll-hijacking/">From pentesterlab</a>&nbsp;<br/>
<br/>
In Windows environments when an application or a service is starting it looks for a number of DLL’s in order to function properly. If these DLL’s doesn’t exist or are implemented in an insecure way (DLL’s are called without using a fully qualified path) then it is possible to escalate privileges by forcing the application to load and execute a malicious DLL file.<br/>
<br/>
It should be noted that when an application needs to load a DLL it will go through the following order:<br/>
<br/>
The directory from which the application is loaded<br/>
C:\Windows\System32<br/>
C:\Windows\System<br/>
C:\Windows<br/>
The current working directory<br/>
Directories in the system PATH environment variable<br/>
Directories in the user PATH environment variable<br/>
<br/>
Step 1 – Processes with Missing DLL’s<br/>
The first step is to list all the processes on the system and discover these processes which are running as SYSTEM and are missing DLL’s. This can be done just by using the process monitor tool from Sysinternals and by applying the filters below:<br/>
<br/>
<img src="image.png" /><br/>
<br/>
Process Monitor will identify if there is any DLL that the application tries to load and the actual path that the application is looking for the missing DLL.<br/>
<br/>
<img src="image 2.png" /><br/>
<br/>
In this example the process Bginfo.exe is missing several DLL files which possibly can be used for privilege escalation.<br/>
<br/>
Step 2 – Folder Permissions<br/>
By default if a software is installed on the C:\ directory instead of the C:\Program Files then authenticated users will have write access on that directory. Additionally software like Perl, Python, Ruby etc. usually are added to Path variable. This give the opportunity of privilege escalation since the user can write a malicious DLL in that directory which is going to be loaded the next time that the process will restart with the permission of that process.<br/>
<br/>
<img src="image 3.png" /><br/>
<br/>
Step 3 – DLL Hijacking<br/>
Metasploit can be used in order to generate a DLL that will contain a payload which will return a session with the privileges of the service.<br/>
<br/>
<img src="image 4.png" /><br/>
<br/>
The process Bginfo.exe it is running as SYSTEM which means these privileges will be granted to the user upon restart of the service since the DLL with the malicious payload will be loaded and executed by the process.<br/>
<br/>
<img src="image 5.png" /><br/>
<br/>
As it has been identified above the process is missing the Riched32.dll so the pentestlab.dll needs to be renamed as Riched32.dll. This will confuse the application and it will try to load it as the application will think that this is a legitimate DLL. This malicious DLL needs to be dropped in one of the folders that windows are loading DLL files.<br/>
<br/>
<img src="image 6.png" /><br/>
<br/>
As it can be see below when the service restarted a Meterpreter session opened with SYSTEM privileges through DLL hijacking.<br/>
<br/>
<img src="image 7.png" /><br/>
<br/>
<br/>
Conclusion<br/>
In order to be able to escalate privileges via DLL hijacking the following conditions needs to be in place:<br/>
<br/>
Write Permissions on a system folder<br/>
Software installation in a non-default directory<br/>
A service that is running as system and is missing a DLL<br/>
Restart of the service<br/>
Discovering applications that are not installed in the Program files it is something common as except of third-party applications that are not forced to be installed in that path there is a possibility of a custom-made software to be found outside of these protected folders. Additionally there are a number of windows services like IKEEXT (IKE and AuthIP IPsec Keying Modules) that are missing DLL’s (wlbsctrl.dll) and can be exploited as well either manually or automatically. For IKEEXT there is a specific Metasploit module:<br/>
<br/>
1 exploit/windows/local/ikeext_service</body></html>